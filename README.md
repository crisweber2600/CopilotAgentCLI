# CopilotAgentCLI

Standalone command-line interface for delegating software tasks to the GitHub Copilot coding agent from any shell.

## Highlights
- Authenticate with GitHub via device code, environment tokens, GitHub PATs, or Copilot session tokens.
- Delegate prompts with rich context (files and folders), monitor progress, stream logs, and retrieve final artifacts.
- Works locally or inside CI/CD runners; persists state under `~/.copilot-agent` by default.
- Optional automatic git commits, branch checkpoints, and remote session syncing with the Copilot Agent service.
- Tested with contract-style Vitest suites to guard the end-to-end CLI workflow.

## Repository Layout
- `src/cli`: Command entry point, argument parsing, and command implementations (`delegate`, `status`, `follow`, etc.).
- `src/services`: Auth, session management, remote Copilot API client, and git automation utilities.
- `src/models`: TypeScript models and validation helpers shared across the CLI.
- `scripts`: Utility scripts such as `build-cli.sh` and `cli-demo.sh` for packaging and demos.
- `dist`: Transpiled JavaScript output (generated by `npm run build`).
- `tests/contract`: Contract tests that exercise the CLI through spawned node processes.

## Prerequisites
- Node.js 18.17 or newer (required for the built-in Fetch API used by remote requests).
- npm 9+ or a compatible package manager.
- Git CLI available on `PATH` for repository detection and auto-commit features.
- Access to the GitHub Copilot Agent private beta (the CLI talks to `https://api.githubcopilot.com`).

## Install and Build
```bash
npm install
npm run build
```

The build step compiles TypeScript into `dist/` and wires the `copilot-cli` binary. You can run the CLI without a global install via:
```bash
npm run cli -- --help
# or directly
node dist/cli/index.js --help
```

To install globally from the checkout:
```bash
npm install -g .
```
This links `copilot-cli` into your global npm bin (remember to rebuild after local changes).

The helper script `scripts/build-cli.sh` wraps the clean/build/pack flow and respects `NODE_ENV=development` to skip tarball packaging.

## Quick Start
1. Authenticate:
   ```bash
   copilot-cli login --method device-code
   ```
   Follow the browser instructions to finish the device-code flow.
2. Delegate a task from a git repository:
   ```bash
   copilot-cli delegate --prompt "Summarize the onboarding docs" --file README.md --json
   ```
3. Watch progress and stream logs:
   ```bash
   copilot-cli follow <session-id>
   ```
4. Retrieve the final summary and artifacts when complete:
   ```bash
   copilot-cli result <session-id> --json
   ```

By default the CLI stores session data in `~/.copilot-agent/sessions.json`. Override this directory with `COPILOT_AGENT_HOME`.

### Global Flags
- `--help`, `-h`: Show top-level help and exit.
- `--verbose`: Print stack traces for unexpected errors.
- `--cwd <path>`: Run a command as if invoked from another working directory.
- `--json` / `--text`: Force output format (defaults to JSON in CI environments).

## Authentication Methods
| Method | Command flag | Requirements |
| ------ | ------------- | ------------ |
| Device Code | `login --method device-code` | Interactive login using `https://github.com/login/device/code` (default).
| Environment Token | `login --method env-token` | Provide `COPILOT_AGENT_TOKEN` in the environment (non-expiring token).
| GitHub PAT | `login --method github-pat` | Provide `GITHUB_PAT` (classic token with at least `repo`, `workflow`, and `read:user` scopes). GitHub’s default Actions token doesn’t carry Copilot scopes, so use a dedicated secret.
| Copilot Session | `login --method github-session` | Requires `COPILOT_CLI_SESSION_COOKIE=user_session=...` and `COPILOT_CLI_GITHUB_CLIENT_SECRET=...` to perform the OAuth exchange without a browser.

The CLI caches credentials at `${COPILOT_AGENT_HOME}/auth.json`. Run `copilot-cli logout` to clear stored credentials.

## Command Reference
Each sub-command accepts `--json` or `--text` to control output formatting.

### `login`
```
copilot-cli login [--method device-code|env-token|github-pat|github-session] [--json|--text]
```
Authenticate with the selected method. Device code login prompts with the verification URL and user code.

### `logout`
```
copilot-cli logout [--json|--text]
```
Clears stored credentials.

### `delegate`
```
copilot-cli delegate --prompt "..." [--file path --folder dir --approve action --interactive|--non-interactive --branch branchName --quiet] [--json|--text]
```
Create a new Copilot Agent session.
- `--prompt` (required): Natural-language task description.
- `--file`, `--folder`: Provide local context files or folders (can repeat flags).
- `--approve`: Pre-authorize specific actions when running non-interactively.
- `--interactive` / `--non-interactive`: Select the interaction mode (defaults to interactive).
- `--branch`, `--base-branch`: Override the detected git branch for remote jobs.
- `--quiet`: Print only the session id (implies JSON output unless `--text` is provided).

The CLI validates that referenced files/folders exist and, when connected to a remote repository, can auto-commit pending changes (see [Session Automation](#session-automation)).

### `status`
```
copilot-cli status <session-id> [--json|--text]
```
Show the latest status, approvals, PR URL, and summary for a session.

### `follow`
```
copilot-cli follow <session-id> [--json|--text]
```
Stream live status and log events until the session finishes or you press Ctrl+C. Configure polling with `COPILOT_CLI_FOLLOW_INTERVAL_MS`.

### `list`
```
copilot-cli list [--status queued|running|waiting|blocked|completed|failed|cancelled] [--json|--text]
```
List stored sessions, optionally filtering by status. Marks sessions that require user input.

### `cancel`
```
copilot-cli cancel <session-id> [--json|--text]
```
Cancel an active session locally and remotely (if supported by the integration).

### `approve`
```
copilot-cli approve <session-id> [--note "..." ] [--json|--text]
```
Approve a pending action for sessions that are waiting on user input. In remote mode, the CLI guides you to approve inside VS Code or GitHub when the API does not yet support approvals.

### `deny`
```
copilot-cli deny <session-id> [--reason "..."] [--json|--text]
```
Deny a pending action. Denials immediately mark the session as failed with your reason recorded.

### `result`
```
copilot-cli result <session-id> [--json|--text]
```
Fetch the final summary and artifact URLs for a completed session. Errors if the session is not in a terminal state.

## Session Automation
When the CLI detects a git repository it can:
- Resolve repository metadata automatically via git or `GITHUB_REPOSITORY`/`GITHUB_REF` in CI.
- Ensure the target branch exists on the remote (`COPILOT_CLI_AUTO_COMMIT_AND_PUSH=1` enables automatic push for missing branches).
- Create checkpoint branches for uncommitted changes when auto-commit is enabled. Messages default to `Checkpoint from Copilot CLI for coding agent session` but can be customized.
- Capture pull request URLs and append them to session artifacts.

To disable automatic commits and pushes, set `COPILOT_CLI_AUTO_COMMIT_AND_PUSH=0` and ensure the working tree is clean before delegating.

## Environment Configuration
| Variable | Purpose |
| -------- | ------- |
| `COPILOT_AGENT_HOME` | Override the directory that stores `auth.json` and `sessions.json` (defaults to `~/.copilot-agent`). |
| `COPILOT_CLI_JSON_DEFAULT` | When truthy, default to JSON output instead of text. CI environments enable this automatically. |
| `COPILOT_CLI_VERBOSE` | When truthy, enables verbose logging for unexpected errors. |
| `COPILOT_CLI_FOLLOW_INTERVAL_MS` | Milliseconds between polls in `follow` (default 2000, minimum 500). |
| `COPILOT_AGENT_RUNNER_MODE` | Force runner mode (`cli` for real remote jobs, `stub` for simulated local runs). |
| `COPILOT_CLI_TEST_MODE` | Enables deterministic stub behavior during tests (`sessions` do not contact remote services). |
| `COPILOT_CLI_AUTO_COMMIT_AND_PUSH` | Truthy to allow automatic commits and push of checkpoint branches (defaults to enabled). |
| `COPILOT_CLI_AUTO_COMMIT_MESSAGE` | Custom commit message when auto committing pending changes. |
| `COPILOT_CLI_REMOTE_NAME` | Override the git remote used for pushes (defaults to `origin`). |
| `COPILOT_CLI_POLL_INTERVAL_MS` | Interval for remote session polling immediately after job creation (default 2000). |
| `COPILOT_CLI_POLL_TIMEOUT_MS` | Timeout window for initial remote polling (default 15000). |
| `GITHUB_REPOSITORY`, `GITHUB_REF`, `GITHUB_HEAD_REF`, `GITHUB_WORKSPACE` | Used in GitHub Actions to infer repository metadata. |
| `COPILOT_AGENT_TOKEN` | Required when using `login --method env-token`. |
| `GITHUB_TOKEN`, `GITHUB_PAT` | Required when using `login --method github-pat`. |

## Scripts and Tooling
- `npm run build`: Compile TypeScript to `dist/`.
- `npm run clean`: Remove the `dist/` folder.
- `npm run cli -- <args>`: Run the CLI directly from source without a global install.
- `scripts/cli-demo.sh`: Sets up a demo workspace under `.demo/` and walks through login, delegation, and result retrieval.

## Testing
The project includes Vitest contract tests under `tests/contract` that spawn the CLI and assert JSON schemas and behaviors.
```bash
# Install test dependencies if needed
npm install --save-dev vitest@latest tsx

# Run the contract suite
npx vitest run tests/contract
```
Tests run in `COPILOT_CLI_TEST_MODE` and use a stub runner, so no live API calls are made. Ensure `tsx` is installed because the tests run the TypeScript entry point directly.

## Exit Codes
| Code | Meaning |
| ---- | ------- |
| 0 | Success. |
| 2 | Validation error (invalid arguments, missing files, etc.). |
| 3 | Authentication failure or expired session. |
| 4 | Policy violation. |
| 5 | Resource not found. |
| 6 | Conflict (e.g., cancelling a finished session). |
| 7 | Operation cancelled. |
| 8 | Upstream provider error (feature not supported yet). |
| 9 | Unexpected error (see `--verbose` for stack traces). |

## Troubleshooting Tips
- **`Unable to detect GitHub repository information`**: Run commands inside a git repository or set `GITHUB_REPOSITORY` and `GITHUB_REF` explicitly.
- **`Uncommitted changes detected`**: Commit or stash pending work, or enable automatic commits with `COPILOT_CLI_AUTO_COMMIT_AND_PUSH=1`.
- **`Authentication required`**: Run `copilot-cli login` again, or set the appropriate token environment variable for non-interactive environments.
- **Device code flow stalls**: Re-run `login --method device-code --json` to obtain a fresh code and ensure the verification page is opened within the expiry window.

## License
The CLI is distributed under the license described in `LICENSE`. Consult that file for full terms.
